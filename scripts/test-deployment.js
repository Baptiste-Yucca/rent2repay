const { ethers } = require("hardhat");

async function main() {
    console.log("üß™ Tests post-d√©ploiement du contrat Rent2Repay...\n");

    // R√©cup√©ration des signers
    const [deployer, admin, emergency, operator, user1, user2] = await ethers.getSigners();

    console.log("üë• Comptes utilis√©s pour les tests :");
    console.log("Deployer:", deployer.address);
    console.log("Admin:", admin.address);
    console.log("Emergency:", emergency.address);
    console.log("Operator:", operator.address);
    console.log("User1:", user1.address);
    console.log("User2:", user2.address);
    console.log();

    // D√©ploiement du contrat
    const Rent2Repay = await ethers.getContractFactory("Rent2Repay");
    const rent2Repay = await Rent2Repay.deploy(
        admin.address,
        emergency.address,
        operator.address
    );

    await rent2Repay.waitForDeployment();
    const contractAddress = await rent2Repay.getAddress();
    console.log("‚úÖ Contrat d√©ploy√© √† l'adresse:", contractAddress);
    console.log();

    // Test 1: V√©rification des r√¥les
    console.log("üîê Test 1: V√©rification des r√¥les");
    try {
        const DEFAULT_ADMIN_ROLE = "0x0000000000000000000000000000000000000000000000000000000000000000";
        const ADMIN_ROLE = await rent2Repay.ADMIN_ROLE();
        const EMERGENCY_ROLE = await rent2Repay.EMERGENCY_ROLE();
        const OPERATOR_ROLE = await rent2Repay.OPERATOR_ROLE();

        const adminHasDefaultRole = await rent2Repay.hasRole(DEFAULT_ADMIN_ROLE, admin.address);
        const adminHasAdminRole = await rent2Repay.hasRole(ADMIN_ROLE, admin.address);
        const emergencyHasRole = await rent2Repay.hasRole(EMERGENCY_ROLE, emergency.address);
        const operatorHasRole = await rent2Repay.hasRole(OPERATOR_ROLE, operator.address);

        console.log("- Admin a DEFAULT_ADMIN_ROLE:", adminHasDefaultRole);
        console.log("- Admin a ADMIN_ROLE:", adminHasAdminRole);
        console.log("- Emergency a EMERGENCY_ROLE:", emergencyHasRole);
        console.log("- Operator a OPERATOR_ROLE:", operatorHasRole);

        if (adminHasDefaultRole && adminHasAdminRole && emergencyHasRole && operatorHasRole) {
            console.log("‚úÖ Test 1 r√©ussi: Tous les r√¥les sont correctement assign√©s\n");
        } else {
            throw new Error("Les r√¥les ne sont pas correctement assign√©s");
        }
    } catch (error) {
        console.log("‚ùå Test 1 √©chou√©:", error.message);
        return;
    }

    // Test 2: Configuration utilisateur
    console.log("üë§ Test 2: Configuration utilisateur");
    try {
        const weeklyAmount = ethers.parseEther("100");

        // User1 configure Rent2Repay
        const tx1 = await rent2Repay.connect(user1).configureRent2Repay([weeklyAmount]);
        await tx1.wait();

        const isAuthorized = await rent2Repay.isAuthorized(user1.address);
        const [maxAmount, lastTimestamp, currentSpent] = await rent2Repay.getUserConfig(user1.address);

        console.log("- User1 configur√© avec succ√®s:", isAuthorized);
        console.log("- Montant hebdomadaire:", ethers.formatEther(maxAmount), "ETH");
        console.log("- Timestamp initial:", lastTimestamp.toString());
        console.log("- Montant d√©pens√© initial:", ethers.formatEther(currentSpent), "ETH");

        if (isAuthorized && maxAmount === weeklyAmount && lastTimestamp === 0n && currentSpent === 0n) {
            console.log("‚úÖ Test 2 r√©ussi: Configuration utilisateur fonctionne\n");
        } else {
            throw new Error("Configuration utilisateur incorrecte");
        }
    } catch (error) {
        console.log("‚ùå Test 2 √©chou√©:", error.message);
        return;
    }

    // Test 3: Validation de repayment
    console.log("üí∞ Test 3: Fonction rent2repay");
    try {
        const repayAmount = ethers.parseEther("30");

        // N'importe qui peut appeler rent2repay
        const tx3 = await rent2Repay.connect(user2).rent2repay(user1.address, repayAmount);
        await tx3.wait();

        const [, newTimestamp, newSpent] = await rent2Repay.getUserConfig(user1.address);
        const available = await rent2Repay.getAvailableAmountThisWeek(user1.address);

        console.log("- Montant rembours√©:", ethers.formatEther(repayAmount), "ETH");
        console.log("- Nouveau montant d√©pens√©:", ethers.formatEther(newSpent), "ETH");
        console.log("- Montant disponible restant:", ethers.formatEther(available), "ETH");
        console.log("- Timestamp mis √† jour:", newTimestamp > 0n);

        if (newSpent === repayAmount && available === ethers.parseEther("70") && newTimestamp > 0n) {
            console.log("‚úÖ Test 3 r√©ussi: Fonction rent2repay fonctionne\n");
        } else {
            throw new Error("Fonction rent2repay incorrecte");
        }
    } catch (error) {
        console.log("‚ùå Test 3 √©chou√©:", error.message);
        return;
    }

    // Test 4: Limite hebdomadaire
    console.log("‚è∞ Test 4: Limite hebdomadaire");
    try {
        const excessiveAmount = ethers.parseEther("80"); // 30 + 80 = 110 > 100

        let limitExceeded = false;
        try {
            await rent2Repay.connect(user2).rent2repay(user1.address, excessiveAmount);
        } catch (error) {
            if (error.message.includes("WeeklyLimitExceeded")) {
                limitExceeded = true;
            }
        }

        console.log("- Tentative de d√©passement de limite:", limitExceeded ? "rejet√©e ‚úÖ" : "accept√©e ‚ùå");

        if (limitExceeded) {
            console.log("‚úÖ Test 4 r√©ussi: Limite hebdomadaire respect√©e\n");
        } else {
            throw new Error("La limite hebdomadaire n'est pas respect√©e");
        }
    } catch (error) {
        console.log("‚ùå Test 4 √©chou√©:", error.message);
        return;
    }

    // Test 5: Fonctions d'urgence
    console.log("üö® Test 5: Fonctions d'urgence");
    try {
        // Emergency pause le contrat
        const tx5a = await rent2Repay.connect(emergency).pause();
        await tx5a.wait();

        const isPaused = await rent2Repay.paused();
        console.log("- Contrat mis en pause:", isPaused);

        // Tentative de configuration pendant la pause
        let pauseEffective = false;
        try {
            await rent2Repay.connect(user2).configureRent2Repay(ethers.parseEther("50"));
        } catch (error) {
            if (error.message.includes("EnforcedPause")) {
                pauseEffective = true;
            }
        }

        console.log("- Configuration bloqu√©e pendant pause:", pauseEffective ? "oui ‚úÖ" : "non ‚ùå");

        // Emergency unpause le contrat
        const tx5b = await rent2Repay.connect(emergency).unpause();
        await tx5b.wait();

        const isUnpaused = !await rent2Repay.paused();
        console.log("- Contrat remis en marche:", isUnpaused);

        if (isPaused && pauseEffective && isUnpaused) {
            console.log("‚úÖ Test 5 r√©ussi: Fonctions d'urgence fonctionnent\n");
        } else {
            throw new Error("Fonctions d'urgence d√©faillantes");
        }
    } catch (error) {
        console.log("‚ùå Test 5 √©chou√©:", error.message);
        return;
    }

    // Test 6: Fonctions op√©rateur
    console.log("‚öôÔ∏è Test 6: Fonctions op√©rateur");
    try {
        // User2 configure d'abord
        await rent2Repay.connect(user2).configureRent2Repay(ethers.parseEther("200"));

        const user2AuthorizedBefore = await rent2Repay.isAuthorized(user2.address);
        console.log("- User2 autoris√© avant suppression:", user2AuthorizedBefore);

        // Operator supprime user2
        const tx6 = await rent2Repay.connect(operator).removeUser(user2.address);
        await tx6.wait();

        const user2AuthorizedAfter = await rent2Repay.isAuthorized(user2.address);
        console.log("- User2 autoris√© apr√®s suppression:", user2AuthorizedAfter);

        if (user2AuthorizedBefore && !user2AuthorizedAfter) {
            console.log("‚úÖ Test 6 r√©ussi: Fonctions op√©rateur fonctionnent\n");
        } else {
            throw new Error("Fonctions op√©rateur d√©faillantes");
        }
    } catch (error) {
        console.log("‚ùå Test 6 √©chou√©:", error.message);
        return;
    }

    // Test 7: R√©vocation utilisateur
    console.log("üö™ Test 7: R√©vocation utilisateur");
    try {
        const user1AuthorizedBefore = await rent2Repay.isAuthorized(user1.address);
        console.log("- User1 autoris√© avant r√©vocation:", user1AuthorizedBefore);

        // User1 r√©voque sa propre autorisation
        const tx7 = await rent2Repay.connect(user1).revokeRent2Repay();
        await tx7.wait();

        const user1AuthorizedAfter = await rent2Repay.isAuthorized(user1.address);
        const [maxAmount, lastTimestamp, currentSpent] = await rent2Repay.getUserConfig(user1.address);

        console.log("- User1 autoris√© apr√®s r√©vocation:", user1AuthorizedAfter);
        console.log("- Donn√©es effac√©es:", maxAmount === 0n && lastTimestamp === 0n && currentSpent === 0n);

        if (user1AuthorizedBefore && !user1AuthorizedAfter && maxAmount === 0n) {
            console.log("‚úÖ Test 7 r√©ussi: R√©vocation utilisateur fonctionne\n");
        } else {
            throw new Error("R√©vocation utilisateur d√©faillante");
        }
    } catch (error) {
        console.log("‚ùå Test 7 √©chou√©:", error.message);
        return;
    }

    // Test 8: Contr√¥les de s√©curit√© rent2repay
    console.log("üîí Test 8: Contr√¥les de s√©curit√© rent2repay");
    try {
        // Reconfigurer user1 pour les tests
        await rent2Repay.connect(user1).configureRent2Repay(ethers.parseEther("100"));

        // Test 8a: Adresse z√©ro
        let zeroAddressBlocked = false;
        try {
            const zeroAddress = "0x0000000000000000000000000000000000000000";
            await rent2Repay.connect(user2).rent2repay(zeroAddress, ethers.parseEther("10"));
        } catch (error) {
            if (error.message.includes("InvalidUserAddress")) {
                zeroAddressBlocked = true;
            }
        }
        console.log("- Adresse z√©ro bloqu√©e:", zeroAddressBlocked ? "oui ‚úÖ" : "non ‚ùå");

        // Test 8b: Auto-repayment bloqu√©
        let selfRepaymentBlocked = false;
        try {
            await rent2Repay.connect(user1).rent2repay(user1.address, ethers.parseEther("10"));
        } catch (error) {
            if (error.message.includes("CannotRepayForSelf")) {
                selfRepaymentBlocked = true;
            }
        }
        console.log("- Auto-repayment bloqu√©:", selfRepaymentBlocked ? "oui ‚úÖ" : "non ‚ùå");

        // Test 8c: Repayment normal fonctionne
        const normalRepayment = await rent2Repay.connect(user2).rent2repay(user1.address, ethers.parseEther("20"));
        const normalSuccess = normalRepayment !== undefined;
        console.log("- Repayment normal fonctionne:", normalSuccess ? "oui ‚úÖ" : "non ‚ùå");

        if (zeroAddressBlocked && selfRepaymentBlocked && normalSuccess) {
            console.log("‚úÖ Test 8 r√©ussi: Contr√¥les de s√©curit√© fonctionnent\n");
        } else {
            throw new Error("Contr√¥les de s√©curit√© d√©faillants");
        }
    } catch (error) {
        console.log("‚ùå Test 8 √©chou√©:", error.message);
        return;
    }

    // R√©sum√© des tests
    console.log("üìã R√©sum√© des tests :");
    console.log("‚úÖ Test 1: V√©rification des r√¥les");
    console.log("‚úÖ Test 2: Configuration utilisateur");
    console.log("‚úÖ Test 3: Fonction rent2repay");
    console.log("‚úÖ Test 4: Limite hebdomadaire");
    console.log("‚úÖ Test 5: Fonctions d'urgence");
    console.log("‚úÖ Test 6: Fonctions op√©rateur");
    console.log("‚úÖ Test 7: R√©vocation utilisateur");
    console.log("‚úÖ Test 8: Contr√¥les de s√©curit√© rent2repay");
    console.log();

    console.log("üéâ Tous les tests post-d√©ploiement ont r√©ussi !");
    console.log("Le contrat Rent2Repay fonctionne parfaitement avec s√©curit√© renforc√©e.");
}

// Gestion des erreurs
main()
    .then(() => {
        console.log("\n‚ú® Tests post-d√©ploiement termin√©s avec succ√®s !");
        process.exit(0);
    })
    .catch((error) => {
        console.error("\nüí• Erreur lors des tests post-d√©ploiement :", error);
        process.exit(1);
    }); 