const { ethers } = require("hardhat");
const fs = require("fs");
const path = require("path");

async function main() {
    console.log("üöÄ D√©marrage du d√©ploiement local des contrats Rent2Repay...");

    // R√©cup√©rer le compte de d√©ploiement
    const [deployer] = await ethers.getSigners();
    console.log("üìã D√©ploiement depuis le compte:", deployer.address);
    console.log("üí∞ Solde du compte:", ethers.formatEther(await deployer.provider.getBalance(deployer.address)), "ETH");

    // Objet pour stocker toutes les adresses d√©ploy√©es
    const deployedAddresses = {
        network: "localhost",
        chainId: 31337,
        deployer: deployer.address,
        deployedAt: new Date().toISOString(),
        contracts: {}
    };

    try {
        // ===== √âTAPE 1: D√©ployer les tokens de test =====
        console.log("\nüìù === √âTAPE 1: D√©ploiement des tokens de test ===");

        const MockERC20Factory = await ethers.getContractFactory("MockERC20");

        // D√©ployer USDC mock
        console.log("ü™ô D√©ploiement de MockUSDC...");
        const mockUSDC = await MockERC20Factory.deploy("Mock USDC", "USDC");
        await mockUSDC.waitForDeployment();
        const usdcAddress = await mockUSDC.getAddress();
        deployedAddresses.contracts.MockUSDC = usdcAddress;
        console.log("‚úÖ MockUSDC d√©ploy√© √†:", usdcAddress);

        // D√©ployer WXDAI mock
        console.log("ü™ô D√©ploiement de MockWXDAI...");
        const mockWXDAI = await MockERC20Factory.deploy("Mock Wrapped XDAI", "WXDAI");
        await mockWXDAI.waitForDeployment();
        const wxdaiAddress = await mockWXDAI.getAddress();
        deployedAddresses.contracts.MockWXDAI = wxdaiAddress;
        console.log("‚úÖ MockWXDAI d√©ploy√© √†:", wxdaiAddress);

        // D√©ployer le token de gouvernance √† une adresse sp√©cifique
        console.log("ü™ô D√©ploiement du token de gouvernance √† l'adresse sp√©cifique...");
        const { network } = require("hardhat");
        const mockDAOFactory = await ethers.getContractFactory("MockERC20");
        await network.provider.send("hardhat_setCode", [
            "0x6382856a731Af535CA6aea8D364FCE67457da438",
            mockDAOFactory.bytecode
        ]);
        const daoTokenAddress = "0x6382856a731Af535CA6aea8D364FCE67457da438";
        const mockDAOToken = mockDAOFactory.attach(daoTokenAddress);
        await mockDAOToken.waitForDeployment();
        deployedAddresses.contracts.DAOToken = daoTokenAddress;
        console.log("‚úÖ Token de gouvernance d√©ploy√© √† l'adresse sp√©cifique:", daoTokenAddress);

        // ===== √âTAPE 2: D√©ployer les tokens de dette =====
        console.log("\nüìù === √âTAPE 2: D√©ploiement des tokens de dette ===");

        const MockDebtTokenFactory = await ethers.getContractFactory("MockDebtToken");

        // D√©ployer debt token pour USDC
        console.log("üè¶ D√©ploiement de MockDebtUSDC...");
        const mockDebtUSDC = await MockDebtTokenFactory.deploy("Aave Variable Debt USDC", "armmv3USDC", usdcAddress);
        await mockDebtUSDC.waitForDeployment();
        const debtUSDCAddress = await mockDebtUSDC.getAddress();
        deployedAddresses.contracts.MockDebtUSDC = debtUSDCAddress;
        console.log("‚úÖ MockDebtUSDC d√©ploy√© √†:", debtUSDCAddress);

        // D√©ployer debt token pour WXDAI
        console.log("üè¶ D√©ploiement de MockDebtWXDAI...");
        const mockDebtWXDAI = await MockDebtTokenFactory.deploy("Aave Variable Debt WXDAI", "armmv3WXDAI", wxdaiAddress);
        await mockDebtWXDAI.waitForDeployment();
        const debtWXDAIAddress = await mockDebtWXDAI.getAddress();
        deployedAddresses.contracts.MockDebtWXDAI = debtWXDAIAddress;
        console.log("‚úÖ MockDebtWXDAI d√©ploy√© √†:", debtWXDAIAddress);

        // ===== √âTAPE 3: D√©ployer le MockRMM =====
        console.log("\nüìù === √âTAPE 3: D√©ploiement du MockRMM ===");

        const MockRMMFactory = await ethers.getContractFactory("MockRMM");
        console.log("üèóÔ∏è D√©ploiement de MockRMM avec les paires token/debtToken...");

        // Pr√©parer les tableaux pour le constructeur
        const tokens = [usdcAddress, wxdaiAddress];
        const debtTokens = [debtUSDCAddress, debtWXDAIAddress];

        console.log("üìã Configuration des paires:");
        console.log("   - USDC:", usdcAddress, "-> DebtUSDC:", debtUSDCAddress);
        console.log("   - WXDAI:", wxdaiAddress, "-> DebtWXDAI:", debtWXDAIAddress);

        const mockRMM = await MockRMMFactory.deploy(tokens, debtTokens);
        await mockRMM.waitForDeployment();
        const rmmAddress = await mockRMM.getAddress();
        deployedAddresses.contracts.MockRMM = rmmAddress;
        console.log("‚úÖ MockRMM d√©ploy√© √†:", rmmAddress);

        // ===== √âTAPE 4: D√©ployer le contrat principal Rent2Repay =====
        console.log("\nüìù === √âTAPE 4: D√©ploiement du contrat Rent2Repay ===");

        const Rent2RepayFactory = await ethers.getContractFactory("Rent2Repay");
        console.log("üè† D√©ploiement de Rent2Repay...");

        // Le constructeur attend: admin, emergency, operator, rmm, wxdaiToken, wxdaiDebtToken, usdcToken, usdcDebtToken
        const rent2Repay = await Rent2RepayFactory.deploy(
            deployer.address, // admin
            deployer.address, // emergency
            deployer.address, // operator
            rmmAddress, // rmm
            wxdaiAddress, // wxdaiToken
            debtWXDAIAddress, // wxdaiDebtToken
            usdcAddress, // usdcToken
            debtUSDCAddress // usdcDebtToken
        );
        await rent2Repay.waitForDeployment();
        const rent2RepayAddress = await rent2Repay.getAddress();
        deployedAddresses.contracts.Rent2Repay = rent2RepayAddress;
        console.log("‚úÖ Rent2Repay d√©ploy√© √†:", rent2RepayAddress);
        const deployedUSDCdebtaddr = await rent2Repay.getDebtToken(usdcAddress);
        const deployedWXDAIdebtaddr = await rent2Repay.getDebtToken(wxdaiAddress);

        console.log(
            deployedUSDCdebtaddr.toLowerCase() === debtUSDCAddress.toLowerCase()
                ? "‚úÖ check debtUSDC address"
                : "‚ùå check debtUSDC address",
            deployedUSDCdebtaddr
        );
        console.log(
            deployedWXDAIdebtaddr.toLowerCase() === debtWXDAIAddress.toLowerCase()
                ? "‚úÖ check debtWXDAI address"
                : "‚ùå check debtWXDAI address",
            deployedWXDAIdebtaddr
        );

        // ===== √âTAPE 5: Configuration initiale =====
        console.log("\nüìù === √âTAPE 5: Configuration initiale ===");

        // Les paires de tokens sont d√©j√† autoris√©es par le constructeur
        console.log("‚úÖ Paires de tokens USDC/DebtUSDC et WXDAI/DebtWXDAI pr√©-autoris√©es par le constructeur");

        // Configurer l'adresse de la tr√©sorerie DAO (utilise le d√©ployeur pour les tests)
        await rent2Repay.updateDaoTreasuryAddress(deployer.address);
        console.log("‚úÖ Adresse de la tr√©sorerie DAO configur√©e:", deployer.address);

        // Configurer le token de r√©duction des frais DAO
        await rent2Repay.updateDaoFeeReductionToken(daoTokenAddress);
        console.log("‚úÖ Token de r√©duction des frais DAO configur√©:", daoTokenAddress);

        // V√©rification de la configuration du token de gouvernance
        const daoConfig = await rent2Repay.getDaoFeeReductionConfiguration();
        console.log(
            daoConfig.token.toLowerCase() === daoTokenAddress.toLowerCase()
                ? "‚úÖ V√©rification du token de gouvernance: Configuration correcte"
                : "‚ùå V√©rification du token de gouvernance: ERREUR DE CONFIGURATION",
            "\n   ‚Üí Attendu:", daoTokenAddress,
            "\n   ‚Üí Re√ßu:", daoConfig.token
        );

        // Configurer le montant minimum pour la r√©duction des frais (1000 tokens)
        const minAmountForFeeReduction = ethers.parseEther("1000");
        await rent2Repay.updateDaoFeeReductionMinimumAmount(minAmountForFeeReduction);
        console.log("‚úÖ Montant minimum pour r√©duction des frais configur√©:", ethers.formatEther(minAmountForFeeReduction));

        // Ajouter des informations de liaison pour les tests
        deployedAddresses.tokenPairs = [
            {
                token: usdcAddress,
                debtToken: debtUSDCAddress,
                name: "USDC",
                symbol: "USDC"
            },
            {
                token: wxdaiAddress,
                debtToken: debtWXDAIAddress,
                name: "WXDAI",
                symbol: "WXDAI"
            }
        ];

        // Ajouter des informations de configuration
        deployedAddresses.configuration = {
            daoFeesBPS: 50, // 0.5%
            senderTipsBPS: 25, // 0.25%
            daoFeeReductionBPS: 5000, // 50%
            daoFeeReductionMinimumAmount: minAmountForFeeReduction.toString(),
            daoTreasuryAddress: deployer.address,
            daoFeeReductionTokenAddress: daoTokenAddress
        };

        console.log("\n‚úÖ === D√âPLOIEMENT TERMIN√â AVEC SUCC√àS ===");

    } catch (error) {
        console.error("‚ùå Erreur lors du d√©ploiement:", error);
        process.exit(1);
    }

    // ===== √âTAPE 6: Sauvegarder les adresses =====
    console.log("\nüìù === √âTAPE 6: Sauvegarde de la configuration ===");

    const configPath = path.join(__dirname, "tmp/", "deployed-contracts.json");
    fs.writeFileSync(configPath, JSON.stringify(deployedAddresses, null, 2));
    console.log("üíæ Configuration sauvegard√©e dans:", configPath);

    // Afficher un r√©sum√©
    console.log("\nüìä === R√âSUM√â DU D√âPLOIEMENT ===");
    console.log("üè† Rent2Repay:", deployedAddresses.contracts.Rent2Repay);
    console.log("üèóÔ∏è MockRMM:", deployedAddresses.contracts.MockRMM);
    console.log("ü™ô MockUSDC:", deployedAddresses.contracts.MockUSDC);
    console.log("ü™ô MockWXDAI:", deployedAddresses.contracts.MockWXDAI);
    console.log("ü™ô MockDAOToken:", deployedAddresses.contracts.DAOToken);
    console.log("üè¶ MockDebtUSDC:", deployedAddresses.contracts.MockDebtUSDC);
    console.log("üè¶ MockDebtWXDAI:", deployedAddresses.contracts.MockDebtWXDAI);

    console.log("\nüîß Pour utiliser ces contrats, r√©f√©rez-vous au fichier:", configPath);
    console.log("üéØ R√©seau: localhost (http://127.0.0.1:8545)");
    console.log("‚õìÔ∏è Chain ID: 31337");
}

main()
    .then(() => process.exit(0))
    .catch((error) => {
        console.error(error);
        process.exit(1);
    }); 